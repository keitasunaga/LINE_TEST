# LINE DID/VCアプリ レポジトリ戦略

## 📋 概要

オープンソース戦略とマルチプラットフォーム対応を考慮した、3レポジトリ構成のアーキテクチャ設計。

### 戦略の背景
- **オープンソース公開**: モジュール化による貢献しやすさ
- **マルチプラットフォーム対応**: LINE、WhatsApp、Slack等への拡張
- **プラットフォーム抽象化**: 共通APIによる開発効率向上

## 🏗️ レポジトリ構成（全体）

```
did-vc-service/           # 🏛️ DID/VCコアサービス
messaging-platform/      # 📱 メッセージング統合プラットフォーム  
web-ui-platform/         # 🎨 統合Webアプリケーション
```

**計3レポジトリ** で構成し、各レポジトリ内はモノレポ管理

## 📦 各レポジトリの詳細設計

### 1. did-vc-service/ （DID/VCコアサービス）

```
did-vc-service/
├── src/
│   ├── did/
│   │   ├── DIDGenerator.ts       # DID生成
│   │   ├── DIDResolver.ts        # DID解決
│   │   └── DIDStorage.ts         # DID保存
│   ├── vc/
│   │   ├── VCIssuer.ts           # VC発行
│   │   ├── VCVerifier.ts         # VC検証
│   │   └── VCStorage.ts          # VC保存
│   ├── blockchain/
│   │   ├── ContractDeployer.ts   # スマートコントラクト
│   │   ├── TransactionManager.ts # トランザクション管理
│   │   └── ChainConnector.ts     # ブロックチェーン接続
│   └── storage/
│       ├── DatabaseRepository.ts # DB操作
│       └── FileStorage.ts        # ファイル保存
├── tests/
├── docs/
└── package.json
```

**NPM公開**: `@your-org/did-vc-service`

### 2. messaging-platform/ （メッセージング統合NestJSアプリ）

```
messaging-platform/
├── libs/
│   └── messaging-core/           # 抽象化ライブラリ（NPM公開用）
│       ├── src/
│       │   ├── abstract/
│       │   │   ├── messaging-adapter.abstract.ts
│       │   │   └── message-types.ts
│       │   └── interfaces/
│       └── package.json
├── src/
│   ├── core/                     # NestJS共通モジュール
│   │   ├── core.module.ts
│   │   └── interfaces/
│   ├── adapters/                 # アダプターモジュール群
│   │   ├── line/
│   │   │   ├── line-adapter.service.ts
│   │   │   ├── line-adapter.module.ts
│   │   │   └── line.controller.ts
│   │   ├── whatsapp/
│   │   │   ├── whatsapp-adapter.service.ts
│   │   │   ├── whatsapp-adapter.module.ts
│   │   │   └── whatsapp.controller.ts
│   │   └── slack/
│   │       ├── slack-adapter.service.ts
│   │       ├── slack-adapter.module.ts
│   │       └── slack.controller.ts
│   ├── app.module.ts
│   └── main.ts
├── examples/
│   ├── line-integration/
│   └── multi-platform-setup/
├── docs/
├── package.json
└── nest-cli.json
```

**公開戦略**:
- `@your-org/messaging-core` （NPMライブラリ）
- NestJSアプリ全体はGitHub Templateとして公開

### 3. web-ui-platform/ （統合Webアプリ）

```
web-ui-platform/
├── packages/
│   ├── shared/                   # 共通ロジック・型定義
│   │   ├── src/
│   │   │   ├── hooks/useDID.ts
│   │   │   ├── services/didService.ts
│   │   │   ├── types/index.ts
│   │   │   └── utils/platform.ts
│   │   └── package.json
│   └── components/               # 共通UIコンポーネント
│       ├── src/
│       │   ├── DIDCard.tsx
│       │   ├── VCViewer.tsx
│       │   ├── QRGenerator.tsx
│       │   └── shared/
│       └── package.json
└── apps/
    └── web-app/                  # 単一Next.jsアプリ
        ├── src/
        │   ├── app/
        │   │   ├── line/         # LINE用ページ
        │   │   │   ├── dashboard/page.tsx
        │   │   │   └── did-info/page.tsx
        │   │   ├── whatsapp/     # WhatsApp用ページ
        │   │   ├── slack/        # Slack用ページ
        │   │   └── api/          # 共通API
        │   ├── components/
        │   │   ├── platform/     # プラットフォーム固有UI
        │   │   │   ├── LINELayout.tsx
        │   │   │   ├── WhatsAppLayout.tsx
        │   │   │   └── SlackLayout.tsx
        │   │   └── shared/       # 共通UI
        │   ├── middleware.ts     # プラットフォーム分岐
        │   └── hooks/
        ├── next.config.js
        └── package.json
```

**NPM公開**:
- `@your-org/web-ui-shared`
- `@your-org/web-ui-components`

## 🎯 プラットフォーム対応戦略

### プラットフォーム抽象化
```typescript
// messaging-platform-core
export abstract class MessagingAdapter {
  abstract sendTextMessage(userId: string, text: string): Promise<void>
  abstract sendWebAppUrl(userId: string, url: string): Promise<void>
  abstract getUserProfile(userId: string): Promise<UserProfile>
  abstract handleWebhook(payload: any): Promise<WebhookEvent[]>
}

// 共通のイベント型
export interface WebhookEvent {
  type: 'message' | 'follow' | 'unfollow'
  userId: string
  message?: Message
  platform: 'line' | 'whatsapp' | 'slack'
}
```

### UI層のプラットフォーム分岐
```typescript
// web-ui-platform/apps/web-app/src/middleware.ts
export function middleware(request: NextRequest) {
  const userAgent = request.headers.get('user-agent') || ''
  const url = request.nextUrl.clone()
  
  // プラットフォーム検出によるルーティング分岐
  if (userAgent.includes('Line')) {
    url.pathname = `/line${url.pathname}`
    return NextResponse.rewrite(url)
  }
  
  if (userAgent.includes('WhatsApp')) {
    url.pathname = `/whatsapp${url.pathname}`
    return NextResponse.rewrite(url)
  }
  
  return NextResponse.next()
}
```

## 🚀 段階的実装ロードマップ

### Phase 1: コア機能開発（現在）
- [ ] `did-vc-service` の基本実装
- [ ] `messaging-platform-line` の実装
- [ ] `web-ui-platform` のLINE対応

### Phase 2: プラットフォーム抽象化
- [ ] `messaging-platform-core` の抽象化
- [ ] LINE Adapterの分離
- [ ] 共通UIコンポーネントの抽出

### Phase 3: マルチプラットフォーム展開
- [ ] WhatsApp Adapter追加
- [ ] Slack Adapter追加
- [ ] プラットフォーム固有UI実装

### Phase 4: オープンソース公開
- [ ] 各パッケージのNPM公開
- [ ] ドキュメント整備
- [ ] サンプルアプリ作成
- [ ] コミュニティ形成

## 📋 技術スタック

### did-vc-service
- **Language**: TypeScript
- **Runtime**: Node.js
- **Database**: PostgreSQL + Prisma
- **Blockchain**: Ethereum/Polygon
- **Testing**: Jest

### messaging-platform
- **Language**: TypeScript
- **Framework**: 各プラットフォームのSDK
- **Testing**: Jest + プラットフォーム固有テスト
- **Build**: Lerna/pnpm workspaces

### web-ui-platform
- **Framework**: Next.js 15
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **State**: Zustand
- **Testing**: Jest + Playwright

## 🔧 開発・運用方針

### モノレポ管理
- **messaging-platform**: pnpm workspaces
- **web-ui-platform**: pnpm workspaces
- **did-vc-service**: 単一パッケージ

### CI/CD戦略
- 各レポジトリ独立のGitHub Actions
- 依存関係の更新は自動PR作成
- セマンティックバージョニング

### セキュリティ
- 各パッケージでのセキュリティスキャン
- プライベートキーの安全な管理
- 定期的な依存関係更新

## 🎉 期待される成果

### 開発効率
- **型安全性**: 全レポジトリでの型共有
- **再利用性**: 各コンポーネントの独立利用
- **拡張性**: 新プラットフォーム追加の容易さ

### オープンソース戦略
- **モジュール化**: 必要な機能のみ利用可能
- **コミュニティ**: 各プラットフォームの専門家による貢献
- **エコシステム**: DID/VCアプリ開発の標準プラットフォーム

---

**更新日**: 2024年12月19日
**作成者**: プロジェクト設計チーム 