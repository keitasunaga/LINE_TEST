# NestJS BOTサーバー開発タスク一覧

## 🎯 概要

LINE BOTサーバーを構築するために必要な全タスクを段階的に整理。
現在のフェーズと進捗を管理するためのチェックリスト。

## 📅 Phase 1: 環境準備 (前提条件)

### 1. LINE Developers環境設定
```bash
📋 ステータス: 🟡 進行中
□ LINE Developersアカウント作成・ログイン
□ プロバイダー作成 (会社/個人名)
□ Messaging APIチャネル作成
□ Webhook設定 (一旦仮URL)
□ チャネルシークレット取得
□ チャネルアクセストークン発行
□ LIFF アプリ作成 (後でWebアプリ用)
□ 友だち追加用QRコード取得
```

**詳細手順:**
```
1. https://developers.line.biz/ にアクセス
2. LINEアカウントでログイン
3. 「プロバイダー作成」をクリック
4. プロバイダー名入力 (例: "個人開発" or 会社名)
5. 「Messaging API」チャネル作成
6. 基本情報入力:
   - チャネル名: "LINE Test Bot"
   - 説明: "テスト用LINE BOT"
   - 大業種: 個人
   - 小業種: 個人（その他）
7. 作成完了後、以下を取得:
   - Channel Secret (基本設定タブ)
   - Channel Access Token (Messaging API設定タブで発行)
```

### 2. GCP環境設定
```bash
📋 ステータス: ⚪ 未開始
□ GCPアカウント作成・プロジェクト作成
□ 必要なAPI有効化
  - Cloud Run API
  - Cloud SQL Admin API  
  - Secret Manager API
  - Artifact Registry API
□ サービスアカウント作成 (GitHub Actions用)
□ IAM権限設定
□ Artifact Registry リポジトリ作成
□ Secret Manager にLINE認証情報保存
```

**詳細手順:**
```bash
# gcloud CLI インストール後
gcloud projects create your-line-bot-project
gcloud config set project your-line-bot-project

# 必要なAPI有効化
gcloud services enable run.googleapis.com
gcloud services enable sqladmin.googleapis.com
gcloud services enable secretmanager.googleapis.com
gcloud services enable artifactregistry.googleapis.com

# Artifact Registry作成
gcloud artifacts repositories create line-bot-server \
  --repository-format=docker \
  --location=asia-northeast1

# サービスアカウント作成
gcloud iam service-accounts create github-actions \
  --display-name="GitHub Actions"

# IAM権限付与
gcloud projects add-iam-policy-binding your-project-id \
  --member="serviceAccount:github-actions@your-project-id.iam.gserviceaccount.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding your-project-id \
  --member="serviceAccount:github-actions@your-project-id.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.admin"

# Secret作成 (LINE設定後)
echo "your-channel-secret" | gcloud secrets create line-channel-secret --data-file=-
echo "your-access-token" | gcloud secrets create line-channel-access-token --data-file=-
```

### 3. GitHub環境設定
```bash
📋 ステータス: ⚪ 未開始
□ GitHubリポジトリ作成
□ GitHub Secrets設定
  - GCP_PROJECT_ID
  - GCP_SA_KEY
□ ローカル開発環境準備
  - Node.js 20インストール確認
  - Git設定
```

**詳細手順:**
```bash
# Node.js 20 確認
node -v  # v20.x.x が表示されること

# NestJS CLI インストール
npm install -g @nestjs/cli

# Git設定確認
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# GitHubリポジトリ作成後
git clone https://github.com/username/LINE_TEST.git
cd LINE_TEST
```

## 📅 Phase 2: NestJS BOTサーバー開発

### 4. プロジェクト初期化
```bash
📋 ステータス: ⚪ 未開始
□ NestJS プロジェクト作成
□ 必要な依存関係インストール
□ TypeScript設定
□ 基本的なディレクトリ構造作成
□ 環境変数設定
□ .gitignore設定
```

**詳細手順:**
```bash
# プロジェクト作成
cd LINE_TEST
nest new bot-server

# 依存関係追加
cd bot-server
npm install @line/bot-sdk @nestjs/config @nestjs/typeorm typeorm pg

# 開発用依存関係
npm install -D @types/node prisma

# 基本構造作成
mkdir -p src/{config,messaging,common,users}
mkdir -p src/messaging/{services,controllers,interfaces,dto}
```

### 5. 基盤機能実装
```bash
📋 ステータス: ⚪ 未開始
□ 設定モジュール作成 (ConfigModule)
□ LINE SDK統合
□ Webhook受信エンドポイント作成
□ メッセージプロセッサー基盤
□ エラーハンドリング
□ ログ設定
□ ヘルスチェック機能
```

**実装ファイル:**
```
- src/config/configuration.ts
- src/messaging/messaging.module.ts
- src/messaging/services/line.service.ts
- src/messaging/controllers/line-webhook.controller.ts
- src/messaging/services/message-processor.service.ts
- src/common/filters/all-exceptions.filter.ts
- src/main.ts (Cloud Run対応)
```

### 6. 基本的なBOT機能
```bash
📋 ステータス: ⚪ 未開始
□ echo BOT機能 (テスト用)
□ メッセージパターン解析
□ 簡単なキーワード応答
□ Webhook署名検証
□ 基本的なレスポンス機能
```

**テスト用応答例:**
```
入力: "こんにちは" → 出力: "こんにちは！元気ですか？"
入力: "天気" → 出力: "天気情報ページ: [URL]"
入力: "メニュー" → 出力: "メニューページ: [URL]"
```

### 7. デプロイ設定
```bash
📋 ステータス: ⚪ 未開始
□ Dockerfile作成
□ GitHub Actions ワークフロー作成
□ 環境変数設定
□ Cloud Run デプロイ設定
□ ドメイン設定 (Webhook URL確定)
```

**成果物:**
```
- Dockerfile
- .github/workflows/deploy-bot.yml
- Cloud RunサービスURL取得
- LINE DevelopersのWebhook URL更新
```

### 8. テスト・デバッグ
```bash
📋 ステータス: ⚪ 未開始
□ ローカルテスト (ngrok等)
□ 単体テスト作成
□ 統合テスト
□ 実際のLINEでの動作確認
□ ログ確認・デバッグ
```

## 🚀 実行順序と優先度

### **最優先 (今日中)**
- [🟡] LINE Developersアカウント作成 ← **進行中**
- [ ] GCPアカウント・プロジェクト作成
- [ ] ローカル環境準備確認

### **次回 (今週中)**
- [ ] LINE Messaging APIチャネル設定完了
- [ ] GCP基本設定 (API有効化、サービスアカウント)
- [ ] NestJS プロジェクト初期化

### **来週予定**
- [ ] 基本的なBOT機能実装
- [ ] デプロイ環境設定
- [ ] 実機テスト

## 📝 メモ・注意事項

### LINE Developers設定時の注意
- プロバイダー名は後から変更困難
- Webhook URLは開発中は何度でも変更可能
- Channel Secretとアクセストークンは厳重管理

### GCP設定時の注意
- プロジェクトIDは一意である必要あり
- サービスアカウントキーは安全に保管
- 無料枠を超えないようモニタリング

### 開発時の注意
- 環境変数は.envファイルで管理（Git管理外）
- ログレベルを適切に設定
- エラーハンドリングを忘れずに

## 🔗 参考リンク

- [LINE Developers](https://developers.line.biz/)
- [LINE Messaging API リファレンス](https://developers.line.biz/ja/docs/messaging-api/)
- [NestJS ドキュメント](https://docs.nestjs.com/)
- [Google Cloud Run ドキュメント](https://cloud.google.com/run/docs)

---

**最終更新**: 2024年12月時点
**次回更新予定**: LINE Developers設定完了後 