# NestJS BOTã‚µãƒ¼ãƒãƒ¼é–‹ç™ºã‚¿ã‚¹ã‚¯ä¸€è¦§

## ğŸ¯ æ¦‚è¦

LINE BOTã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå…¨ã‚¿ã‚¹ã‚¯ã‚’æ®µéšçš„ã«æ•´ç†ã€‚
ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã¨é€²æ—ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‚

## ğŸ“… Phase 1: ç’°å¢ƒæº–å‚™ (å‰ææ¡ä»¶)

### 1. LINE Developersç’°å¢ƒè¨­å®š
```bash
ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ğŸŸ¡ é€²è¡Œä¸­
â–¡ LINE Developersã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³
â–¡ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ä½œæˆ (ä¼šç¤¾/å€‹äººå)
â–¡ Messaging APIãƒãƒ£ãƒãƒ«ä½œæˆ
â–¡ Webhookè¨­å®š (ä¸€æ—¦ä»®URL)
â–¡ ãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå–å¾—
â–¡ ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ
â–¡ LIFF ã‚¢ãƒ—ãƒªä½œæˆ (å¾Œã§Webã‚¢ãƒ—ãƒªç”¨)
â–¡ å‹ã ã¡è¿½åŠ ç”¨QRã‚³ãƒ¼ãƒ‰å–å¾—
```

**è©³ç´°æ‰‹é †:**
```
1. https://developers.line.biz/ ã«ã‚¢ã‚¯ã‚»ã‚¹
2. LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
3. ã€Œãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åå…¥åŠ› (ä¾‹: "å€‹äººé–‹ç™º" or ä¼šç¤¾å)
5. ã€ŒMessaging APIã€ãƒãƒ£ãƒãƒ«ä½œæˆ
6. åŸºæœ¬æƒ…å ±å…¥åŠ›:
   - ãƒãƒ£ãƒãƒ«å: "LINE Test Bot"
   - èª¬æ˜: "ãƒ†ã‚¹ãƒˆç”¨LINE BOT"
   - å¤§æ¥­ç¨®: å€‹äºº
   - å°æ¥­ç¨®: å€‹äººï¼ˆãã®ä»–ï¼‰
7. ä½œæˆå®Œäº†å¾Œã€ä»¥ä¸‹ã‚’å–å¾—:
   - Channel Secret (åŸºæœ¬è¨­å®šã‚¿ãƒ–)
   - Channel Access Token (Messaging APIè¨­å®šã‚¿ãƒ–ã§ç™ºè¡Œ)
```

### 2. GCPç’°å¢ƒè¨­å®š
```bash
ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âšª æœªé–‹å§‹
â–¡ GCPã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
â–¡ å¿…è¦ãªAPIæœ‰åŠ¹åŒ–
  - Cloud Run API
  - Cloud SQL Admin API  
  - Secret Manager API
  - Artifact Registry API
â–¡ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ (GitHub Actionsç”¨)
â–¡ IAMæ¨©é™è¨­å®š
â–¡ Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
â–¡ Secret Manager ã«LINEèªè¨¼æƒ…å ±ä¿å­˜
```

**è©³ç´°æ‰‹é †:**
```bash
# gcloud CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œ
gcloud projects create your-line-bot-project
gcloud config set project your-line-bot-project

# å¿…è¦ãªAPIæœ‰åŠ¹åŒ–
gcloud services enable run.googleapis.com
gcloud services enable sqladmin.googleapis.com
gcloud services enable secretmanager.googleapis.com
gcloud services enable artifactregistry.googleapis.com

# Artifact Registryä½œæˆ
gcloud artifacts repositories create line-bot-server \
  --repository-format=docker \
  --location=asia-northeast1

# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
gcloud iam service-accounts create github-actions \
  --display-name="GitHub Actions"

# IAMæ¨©é™ä»˜ä¸
gcloud projects add-iam-policy-binding your-project-id \
  --member="serviceAccount:github-actions@your-project-id.iam.gserviceaccount.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding your-project-id \
  --member="serviceAccount:github-actions@your-project-id.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.admin"

# Secretä½œæˆ (LINEè¨­å®šå¾Œ)
echo "your-channel-secret" | gcloud secrets create line-channel-secret --data-file=-
echo "your-access-token" | gcloud secrets create line-channel-access-token --data-file=-
```

### 3. GitHubç’°å¢ƒè¨­å®š
```bash
ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âšª æœªé–‹å§‹
â–¡ GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
â–¡ GitHub Secretsè¨­å®š
  - GCP_PROJECT_ID
  - GCP_SA_KEY
â–¡ ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒæº–å‚™
  - Node.js 20ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
  - Gitè¨­å®š
```

**è©³ç´°æ‰‹é †:**
```bash
# Node.js 20 ç¢ºèª
node -v  # v20.x.x ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨

# NestJS CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g @nestjs/cli

# Gitè¨­å®šç¢ºèª
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆå¾Œ
git clone https://github.com/username/LINE_TEST.git
cd LINE_TEST
```

## ğŸ“… Phase 2: NestJS BOTã‚µãƒ¼ãƒãƒ¼é–‹ç™º

### 4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
```bash
ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âšª æœªé–‹å§‹
â–¡ NestJS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
â–¡ å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
â–¡ TypeScriptè¨­å®š
â–¡ åŸºæœ¬çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ä½œæˆ
â–¡ ç’°å¢ƒå¤‰æ•°è¨­å®š
â–¡ .gitignoreè¨­å®š
```

**è©³ç´°æ‰‹é †:**
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
cd LINE_TEST
nest new bot-server

# ä¾å­˜é–¢ä¿‚è¿½åŠ 
cd bot-server
npm install @line/bot-sdk @nestjs/config @nestjs/typeorm typeorm pg

# é–‹ç™ºç”¨ä¾å­˜é–¢ä¿‚
npm install -D @types/node prisma

# åŸºæœ¬æ§‹é€ ä½œæˆ
mkdir -p src/{config,messaging,common,users}
mkdir -p src/messaging/{services,controllers,interfaces,dto}
```

### 5. åŸºç›¤æ©Ÿèƒ½å®Ÿè£…
```bash
ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âšª æœªé–‹å§‹
â–¡ è¨­å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ (ConfigModule)
â–¡ LINE SDKçµ±åˆ
â–¡ Webhookå—ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
â–¡ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼åŸºç›¤
â–¡ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
â–¡ ãƒ­ã‚°è¨­å®š
â–¡ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
```
- src/config/configuration.ts
- src/messaging/messaging.module.ts
- src/messaging/services/line.service.ts
- src/messaging/controllers/line-webhook.controller.ts
- src/messaging/services/message-processor.service.ts
- src/common/filters/all-exceptions.filter.ts
- src/main.ts (Cloud Runå¯¾å¿œ)
```

### 6. åŸºæœ¬çš„ãªBOTæ©Ÿèƒ½
```bash
ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âšª æœªé–‹å§‹
â–¡ echo BOTæ©Ÿèƒ½ (ãƒ†ã‚¹ãƒˆç”¨)
â–¡ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ã‚¿ãƒ¼ãƒ³è§£æ
â–¡ ç°¡å˜ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”
â–¡ Webhookç½²åæ¤œè¨¼
â–¡ åŸºæœ¬çš„ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹æ©Ÿèƒ½
```

**ãƒ†ã‚¹ãƒˆç”¨å¿œç­”ä¾‹:**
```
å…¥åŠ›: "ã“ã‚“ã«ã¡ã¯" â†’ å‡ºåŠ›: "ã“ã‚“ã«ã¡ã¯ï¼å…ƒæ°—ã§ã™ã‹ï¼Ÿ"
å…¥åŠ›: "å¤©æ°—" â†’ å‡ºåŠ›: "å¤©æ°—æƒ…å ±ãƒšãƒ¼ã‚¸: [URL]"
å…¥åŠ›: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼" â†’ å‡ºåŠ›: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸: [URL]"
```

### 7. ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
```bash
ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âšª æœªé–‹å§‹
â–¡ Dockerfileä½œæˆ
â–¡ GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ
â–¡ ç’°å¢ƒå¤‰æ•°è¨­å®š
â–¡ Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
â–¡ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š (Webhook URLç¢ºå®š)
```

**æˆæœç‰©:**
```
- Dockerfile
- .github/workflows/deploy-bot.yml
- Cloud Runã‚µãƒ¼ãƒ“ã‚¹URLå–å¾—
- LINE Developersã®Webhook URLæ›´æ–°
```

### 8. ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°
```bash
ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âšª æœªé–‹å§‹
â–¡ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ (ngrokç­‰)
â–¡ å˜ä½“ãƒ†ã‚¹ãƒˆä½œæˆ
â–¡ çµ±åˆãƒ†ã‚¹ãƒˆ
â–¡ å®Ÿéš›ã®LINEã§ã®å‹•ä½œç¢ºèª
â–¡ ãƒ­ã‚°ç¢ºèªãƒ»ãƒ‡ãƒãƒƒã‚°
```

## ğŸš€ å®Ÿè¡Œé †åºã¨å„ªå…ˆåº¦

### **æœ€å„ªå…ˆ (ä»Šæ—¥ä¸­)**
- [ğŸŸ¡] LINE Developersã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ â† **é€²è¡Œä¸­**
- [ ] GCPã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒæº–å‚™ç¢ºèª

### **æ¬¡å› (ä»Šé€±ä¸­)**
- [ ] LINE Messaging APIãƒãƒ£ãƒãƒ«è¨­å®šå®Œäº†
- [ ] GCPåŸºæœ¬è¨­å®š (APIæœ‰åŠ¹åŒ–ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)
- [ ] NestJS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–

### **æ¥é€±äºˆå®š**
- [ ] åŸºæœ¬çš„ãªBOTæ©Ÿèƒ½å®Ÿè£…
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒè¨­å®š
- [ ] å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ

## ğŸ“ ãƒ¡ãƒ¢ãƒ»æ³¨æ„äº‹é …

### LINE Developersè¨­å®šæ™‚ã®æ³¨æ„
- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åã¯å¾Œã‹ã‚‰å¤‰æ›´å›°é›£
- Webhook URLã¯é–‹ç™ºä¸­ã¯ä½•åº¦ã§ã‚‚å¤‰æ›´å¯èƒ½
- Channel Secretã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯å³é‡ç®¡ç†

### GCPè¨­å®šæ™‚ã®æ³¨æ„
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¯ä¸€æ„ã§ã‚ã‚‹å¿…è¦ã‚ã‚Š
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã¯å®‰å…¨ã«ä¿ç®¡
- ç„¡æ–™æ ã‚’è¶…ãˆãªã„ã‚ˆã†ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### é–‹ç™ºæ™‚ã®æ³¨æ„
- ç’°å¢ƒå¤‰æ•°ã¯.envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ï¼ˆGitç®¡ç†å¤–ï¼‰
- ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’é©åˆ‡ã«è¨­å®š
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¿˜ã‚Œãšã«

## ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯

- [LINE Developers](https://developers.line.biz/)
- [LINE Messaging API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://developers.line.biz/ja/docs/messaging-api/)
- [NestJS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.nestjs.com/)
- [Google Cloud Run ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/run/docs)

---

**æœ€çµ‚æ›´æ–°**: 2024å¹´12æœˆæ™‚ç‚¹
**æ¬¡å›æ›´æ–°äºˆå®š**: LINE Developersè¨­å®šå®Œäº†å¾Œ 